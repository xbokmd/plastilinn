<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://xbokmd.github.io/plastilinn/css.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <style>
        .custom-flex-1 {
            flex: 0 0 20%;
        }

        .custom-flex-2 {
            flex: 0 0 60%;
        }

        .custom-flex-3 {
            flex: 0 0 20%;
        }

span[data-tag="\2A"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\2A"]::before { content: "⭐1";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\2A\2A"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\2A\2A"]::before { content: "⭐2";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\2A\2A\2A"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\2A\2A\2A"]::before { content: "⭐3";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\2A\2A\2A\2A"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\2A\2A\2A\2A"]::before { content: "⭐4";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\2A\2A\2A\2A\2A"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\2A\2A\2A\2A\2A"]::before { content: "⭐5";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\3F"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3F"]::before { content: "❓1";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\3F\3F"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3F\3F"]::before { content: "❓2";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\3F\3F\3F"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3F\3F\3F"]::before { content: "❓3";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\3F\3F\3F\3F"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3F\3F\3F\3F"]::before { content: "❓4";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\3F\3F\3F\3F\3F"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3F\3F\3F\3F\3F"]::before { content: "❓5";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\A1"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\A1"]::before { content: "🔥1";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\A1\A1"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\A1\A1"]::before { content: "🔥2";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\A1\A1\A1"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\A1\A1\A1"]::before { content: "🔥3";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\A1\A1\A1\A1"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\A1\A1\A1\A1"]::before { content: "🔥4";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\A1\A1\A1\A1\A1"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\A1\A1\A1\A1\A1"]::before { content: "🔥5";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\21"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\21"]::before { content: "🚩1";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\21\21"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\21\21"]::before { content: "🚩2";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\21\21\21"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\21\21\21"]::before { content: "🚩3";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\21\21\21\21"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\21\21\21\21"]::before { content: "🚩4";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\21\21\21\21\21"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\21\21\21\21\21"]::before { content: "🚩5";  filter: filter: hue-rotate(90deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: red; }
span[data-tag="\3D"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3D"]::before { content: "✅1";  filter: hue-rotate(90deg) brightness(0.8) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: green; }
span[data-tag="\3D\3D"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3D\3D"]::before { content: "✅2";  filter: hue-rotate(90deg) brightness(0.8) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: green; }
span[data-tag="\3D\3D\3D"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3D\3D\3D"]::before { content: "✅3";  filter: hue-rotate(90deg) brightness(0.8) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: green; }
span[data-tag="\3D\3D\3D\3D"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3D\3D\3D\3D"]::before { content: "✅4";  filter: hue-rotate(90deg) brightness(0.8) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: green; }
span[data-tag="\3D\3D\3D\3D\3D"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\3D\3D\3D\3D\3D"]::before { content: "✅5";  filter: hue-rotate(90deg) brightness(0.8) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: green; }
span[data-tag="\25"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\25"]::before { content: "👍1";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.2; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\25\25"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\25\25"]::before { content: "👍2";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.4; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\25\25\25"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\25\25\25"]::before { content: "👍3";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.6; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\25\25\25\25"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\25\25\25\25"]::before { content: "👍4";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 0.8; pointer-events: none; user-select: none;  color: blue; }
span[data-tag="\25\25\25\25\25"] { position: relative; font-size: 0; pointer-events: none;} span[data-tag="\25\25\25\25\25"]::before { content: "👍5";  filter: hue-rotate(180deg) brightness(0.5) saturate(5); font-size: 15px; opacity: 1; pointer-events: none; user-select: none;  color: blue; }

    </style>

</head>

<body class="bg-gray-100">
    <div id="top-container">
        <div class="navbar bg-base-100">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl">Plastilinn</a>
            </div>
            <div class="flex-none">
                <ul class="menu menu-horizontal px-1">
                    <li><a>App</a></li>
                    <li><a>Docs</a></li>
                    <li><a>About</a></li>
                </ul>
            </div>
        </div>
        <main id="document-controls" class="container mx-auto mt-8">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <input type="file" id="markdownFileInput" accept=".md">
                </div>
                <div class="flex space-x-3">
                    <select class="select select-bordered w-full max-w-xs" id="tagsFilter"
                        onchange="filterLinesBySelectedTags()">
                    </select>
                    <button
                        class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition"
                        onclick="extractTags()">Refresh filter</button>
                    <button id="downloadBtn"
                        class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition">Download</button>
                </div>
            </div>
    </div>
    </div>
    <div id="markdownContainer">
        <div id="md-lines" class="md-lines">
            <div class="hero min-h-screen bg-base-200">
                <div class="hero-content text-center">
                    <div class="max-w-md">
                        <h1 class="text-5xl font-bold">Your business plan powered by Artificial Intelligence</h1>
                        <p class="py-6">Plastilinn offers guidance on completing your business model, including aspects
                            such
                            as market analysis, marketing strategies, financial planning, organizational structure,
                            understanding market trends, analyzing customer demographics, and evaluating competitor
                            behavior. It can help you make informed choices by evaluating different strategic options,
                            and
                            provides continuous support and instant feedback, crucial for iterative business development
                            and
                            improvement.</p>
                        <ul class="steps">
                            <li class="step step-primary">Design your Business Model</li>
                            <li class="step">Analyze your Business Model</li>
                            <li class="step">Validate your Business Model</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-row items-center bg-gray-100 p-4 my-2 rounded-lg shadow space-x-2">
            <div class="flex flex-1 text-center bg-gray-50 rounded p-2" style="flex: 0 0 20%;">CONTENIDO DE LA PRIMERA
                COLUMNA</div>
            <div class="flex flex-1 text-center bg-gray-50 rounded p-2" style="flex: 0 0 60%;">CONTENIDO DE LA SEGUNDA
                COLUMNA</div>
            <div class="flex flex-1 text-center bg-gray-50 rounded p-2 text-gray-500 text-sm" style="flex: 0 0 20%;">
                CONTENIDO DE LA TERCERA COLUMNA</div>
        </div>

        </main>
        <div id="markdownContainer"></div>
    </div>
    </div>

    <script>
        let metamodel = [];
        let model = []; // También aseguramos que `model` esté definido globalmente
        document.addEventListener('DOMContentLoaded', function () {
            let metamodel = [];

            function downloadJSON() {
                axios.get('https://xbokmd.github.io/plastilinn/metamodel.json')
                    .then(function (response) {
                        metamodel = response.data;
                        console.log(metamodel); // Opcional: Mostrar los datos en la consola

                        // Crear un elemento para mostrar los datos del array "metamodel"
                        const container = document.createElement('div');
                        container.id = 'metamodelContainer';
                        container.className = 'mt-4 p-4 bg-gray-200'; // Añade estilos según necesites

                        // Convertir el array "metamodel" a una cadena JSON para mostrarlo
                        const content = document.createTextNode(JSON.stringify(metamodel, null, 2));
                        container.appendChild(content);

                        // Añadir el contenedor al final del cuerpo del documento
                        document.body.appendChild(container);
                    })
                    .catch(function (error) {
                        console.log(error); // Manejar el error
                    });
            }

            downloadJSON();
        });


        document.addEventListener('DOMContentLoaded', function () {
            let model = []; // Continuamos usando el nombre de variable "model"

            const markdownFileInput = document.getElementById('markdownFileInput');
            const markdownContainer = document.getElementById('markdownContainer');

            markdownFileInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;
                    const lines = content.split(/\r?\n/);
                    model = _.map(lines, (line, index) => {
                        // Extracción de etiquetas
                        const rawTags = line.match(/#[^\s#]+/g) || [];
                        const tags = rawTags.map(tag => {
                        const tagName = tag.substring(1); // Simplemente elimina el símbolo '#' al principio
                            return { raw: tag, className: tagName };
                        });

                        // Intentar identificar y procesar títulos con nueva especificación
                        let title = undefined;
                        // La expresión regular ahora permite espacios/guiones al inicio y busca de 2 a 10 hashes
                        const headingMatch = line.match(/^\s*-*\s*#{2,10}\s*(.*)/);
                        if (headingMatch && headingMatch[1]) {
                            // Limpiar el título: elimina hashes y espacios iniciales, mantiene texto después de los hashes
                            title = headingMatch[1].trim();
                            // Eliminar etiquetas del título si es necesario
                            title = title.replace(/#[^\s#]+/g, '').trim();
                            title = title.replace(/\[\[|\]\]/g, '');
                        }

                        return {
                            content: line,
                            tags: tags,
                            index: index,
                            title: title // Agregado condicionalmente, undefined si no es un título
                        };
                    });

                    renderModel(); // Asegúrate de ajustar esta función para manejar "title"
                };

                reader.readAsText(file);
            });



            function renderModel() {
                markdownContainer.innerHTML = ''; // Limpiar el contenedor

                const mainContainer = document.createElement('div');
                mainContainer.className = 'flex flex-col';

                _.forEach(model, (lineData) => {
                    const lineContainer = document.createElement('div');
                    lineContainer.className = 'flex flex-row items-center bg-gray-100 p-4 my-2 rounded-lg shadow space-x-2';

                    // Comprobar si el título de la línea coincide con algún nombre en metamodel
                    const matchingMeta = metamodel.find(meta => meta.name === lineData.title);

                    // Columna para el título (ajustada para mostrar el título directamente si existe)
                    const processedContentElement = document.createElement('div');
                    processedContentElement.className = 'text-center bg-gray-50 rounded p-2 custom-flex-1';

                    // Mostrar el título de la línea si existe, de lo contrario dejar en blanco
                    processedContentElement.textContent = lineData.title ? lineData.title : '';
                    lineContainer.appendChild(processedContentElement);

                    // Contenedor para el contenido original (editable)
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'text-center bg-gray-50 rounded p-2 custom-flex-2';
                    const contentElement = document.createElement('div');
                    contentElement.className = 'w-full outline-none';
                    contentElement.setAttribute('contenteditable', 'true');

                    contentElement.addEventListener('input', function() {
                        // Captura las etiquetas directamente del contenido, incluyendo el símbolo '#'
                        const newTags = this.textContent.match(/#[^\s#]+/g) || [];
                        // No necesitas limpiar los caracteres especiales para data-tag
                        // Simplemente elimina el símbolo '#' al principio para el valor del data-tag
                        const cleanedTags = newTags.map(tag => tag.substring(1)); // Mantén los caracteres especiales

                        // Limpiar el contenedor de etiquetas actual antes de añadir las nuevas
                        tagsElement.innerHTML = '';

                        // Generar y añadir los nuevos elementos de etiquetas con data-tag
                        cleanedTags.forEach(tag => {
                            const tagSpan = document.createElement('span');
                            tagSpan.setAttribute('data-tag', tag); // Asigna el valor de la etiqueta al atributo 'data-tag'
                            tagSpan.textContent = tag; // Establece el texto visible del span como el valor de la etiqueta, sin '#'
                            tagsElement.appendChild(tagSpan);
                            tagsElement.appendChild(document.createTextNode(' ')); // Espacio entre etiquetas
                        });
                    });


                    contentElement.textContent = lineData.content;
                    contentContainer.appendChild(contentElement);

                    // Columna para las etiquetas
                    const tagsElement = document.createElement('div');
                    tagsElement.className = 'text-gray-500 text-sm text-center bg-gray-50 rounded p-2 custom-flex-3';
                    lineData.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        // Limpiar el texto de la etiqueta para usarlo como nombre de clase
                        // Eliminamos el símbolo '#' y caracteres especiales, reemplazando con guiones si es necesario
                        tagSpan.setAttribute('data-tag', tag.className); // Almacena el valor de la etiqueta
                        tagSpan.textContent = tag.className; // Establece el texto visible del span
                        tagsElement.appendChild(tagSpan);
                        tagsElement.appendChild(document.createTextNode(' ')); // Espacio entre etiquetas
                    });
                    lineContainer.appendChild(tagsElement);

                    // Añadir el contenedor de contenido editable en el medio
                    lineContainer.insertBefore(contentContainer, tagsElement);

                    // Añadir el contenedor de la línea al contenedor principal
                    mainContainer.appendChild(lineContainer);
                });

                // Añadir el contenedor principal al contenedor de Markdown
                markdownContainer.appendChild(mainContainer);
            }
            function setupEditableContent(contentElement) {
                const editIndicator = document.createElement('span');
                editIndicator.className = 'text-gray-400 text-xl cursor-pointer absolute right-0 mr-4 opacity-0';
                editIndicator.textContent = '✏️';
                contentElement.parentNode.appendChild(editIndicator);

                contentElement.addEventListener('focus', function () {
                    this.classList.add('border', 'border-blue-500', 'rounded', 'p-1');
                });
                contentElement.addEventListener('blur', function () {
                    this.classList.remove('border', 'border-blue-500', 'rounded', 'p-1');
                });
                contentElement.addEventListener('mouseenter', function () {
                    editIndicator.style.opacity = '1';
                });
                contentElement.addEventListener('mouseleave', function () {
                    editIndicator.style.opacity = '0';
                });
            }



        });
    </script>

</body>

</html>