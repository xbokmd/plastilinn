<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://xbokmd.github.io/plastilinn/css.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-multiselect@2.1.6"></script>
    <link rel="stylesheet" href="https://unpkg.com/vue-multiselect@2.1.6/dist/vue-multiselect.min.css">
    <style>
a {
    color: blue;
    text-decoration: underline;
}
        .md-block {
            display: flex;
            /* o display: grid; dependiendo de tu estructura */
            gap: 10px;
            /* Ajusta este valor seg√∫n lo necesites */
        }

        .md-block-container-middle>div {
            /* Tus estilos aqu√≠ */
            border-bottom: 1px solid #F5F5F5;
            padding: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .toastui-editor-defaultUI div[contenteditable="true"] {
            text-align: left;
        }
#bp-web-widget-container {
        width: 50%; height: 80%; z-index: 1000000; position: relative;
}
    </style>

</head>

<body class="bg-gray-100">
    <div id="vue-app">
        <div id="top-container">
            <div class="navbar bg-base-100">
                <div class="flex-1">
                    <a class="btn btn-ghost text-xl">Plastilinn</a>
                </div>
                <div class="flex items-center space-x-3">
                </div>
                <div style="display: flex; justify-content: center;">
                    <div class="flex space-x-3">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="flex items-center space-x-3" style="justify-content: flex-end;">
                            </div>
                            <div class="flex space-x-3" style="justify-content: center;">
                                <button
                                    class="collapse-filter-button btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition"
                                    type="
                                button">
                                    üîç Filter
                                </button>
                            </div>
                            <div class="flex items-center justify-end space-x-3" style="justify-content: flex-start;">
                                <button id="downloadBtn"
                                    class="btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition">‚¨áÔ∏è
                                    Download</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-none">
                    <ul class="menu menu-horizontal px-1">
                        <li><a>App</a></li>
                        <li><a>Docs</a></li>
                        <li><a>About</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="model-title" class="text-center mt-6">
            <!-- El nombre del modelo se mostrar√° aqu√≠ -->
        </div>
        <div class="mt-4 w-4/5 mx-auto">
            <div class="collapse-filter-content hidden ">
                <select class="select select-bordered w-full" id="tagsFilter" multiple>
                    <!-- Opciones del filtro ser√°n generadas din√°micamente -->
                </select>
            </div>
        </div>
        <button id="downloadBtn" @click="downloadMarkdown" class="btn ...">‚¨áÔ∏è Download</button>
        <!-- El input de archivo Markdown se mover√° aqu√≠, gestionado por Vue -->
        <input type="file" @change="loadAndParseMarkdown" accept=".md"
            class="file-input file-input-bordered file-input-primary w-full max-w-xs m-4">
        <!-- El resto de tu aplicaci√≥n Vue -->
        <h1 v-if="modelName">{{ modelName }}</h1>
        <div class="modelContainer mt-4 ml-2 mr-2 text-gray-900 min-h-screen">
            <div class="flex flex-row w-full">
                <div class="md-block-wrapper w-full">
                    <div v-for="block in parsedModel" :key="block.id" class="md-block flex">
                        <div class="md-block-container-left w-1/4">
                            <div class="block-metamodel" v-if="block.metamodel">
                                <a :href="block.metamodel.info" target="_blank">{{ block.metamodel.name }}</a>
                            </div>
                        </div>
                        <div
                            class="md-block-container-middle md-block-content shadow-xl hover:shadow-2xl transition-shadow p-2 ml-2 mr-2 custom-flex-2 w-1/2">
                            <div v-html="block.parsedContent"></div>
                        </div><button @click="openModal(block)"
                            class="btn inblock-block rounded px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-primary transition duration-150 ease-in-out hover:bg-neutral-100 hover:text-primary-600 focus:text-primary-600 focus:outline-none focus:ring-0 active:text-primary-700 m-0 p-2">‚úèÔ∏è</button>
                        <div class="md-block-container-right tags-container text-gray-500 text-sm text-center p-2 w-1/4"
                            v-html="block.tagsParsed"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal para editar el contenido de la l√≠nea seleccionada -->

        <div v-if="isModalOpen" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-4/5 shadow-lg rounded-md bg-white">
                <div class="flex">
                     <div class="mt-3 text-center">
                        <div class="mt-2">
                            <div id="editor-container"></div>
                        </div>
                        <button class="btn m-2" @click="sendMessageToBot()">ü§ñ AI suggest content</button>
                        <button class="btn m-2" @click="saveChanges">üíæ Save changes</button>
                        <button class="btn m-2" @click="closeModal">‚ùå Close window</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        Vue.createApp({
            data() {
                return {
                    metamodel: [],
                    model: [], // Se utilizar√° para almacenar el modelo de datos creado a partir del Markdown
                    lastId: 0, // Inicializa un contador para los IDs
                    modelName: '',
                    modelMarkdown: '', // Campo para almacenar el contenido Markdown concatenado
                    isModalOpen: false,
                    selectedBlockContent: '',
                    selectedBlockIndex: null,
                    blocks: [], // Puedes inicializarlo como un array vac√≠o o con valores iniciales
                    currentBlockId: null,
                };
            },
            computed: {
                parsedModel() {
                    return this.model.map(block => {
                        return { ...block, parsedContent: marked.parse(block.content) };
                    });
                }
            },
            methods: {
                loadAndParseMarkdown(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return;
                    }
                    const modelName = this.getModelNameFromFileName(file.name);
                    this.modelName = modelName; // Actualiza modelName con el resultado de la funci√≥n
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        this.parseMarkdown(content);
                    };
                    reader.readAsText(file);
                },
                getModelNameFromFileName(fileName) {
                    let name = fileName.replace(/\.md$/, ''); // Elimina la extensi√≥n ".md"
                    name = name.replace(/ - saved.*$/, ''); // Elimina " - saved" y todo lo que sigue
                    return name;
                },
                parseMarkdown(content) {
                    const blocks = []; // Almacenar√° los bloques identificados
                    let currentBlock = []; // Almacena las l√≠neas del bloque actual
                    const lines = content.split(/\r?\n/); // Divide el contenido en l√≠neas

                    lines.forEach(line => {
                        // Verifica si la l√≠nea actual marca el inicio de un nuevo bloque
                        if (/^\s*-*\s*#/.test(line)) {
                            if (currentBlock.length > 0) {
                                blocks.push(currentBlock.join('\n')); // Agrega el bloque actual a los bloques
                                currentBlock = []; // Reinicia el bloque actual
                            }
                        }
                        currentBlock.push(line); // A√±ade la l√≠nea al bloque actual
                    });
                    if (currentBlock.length > 0) {
                        blocks.push(currentBlock.join('\n')); // Aseg√∫rate de a√±adir el √∫ltimo bloque
                    }

                    // Actualiza this.model para que contenga bloques en lugar de l√≠neas individuales
                    this.model = blocks.map((blockContent, index) => {
                        this.lastId += 1; // Incrementa el ID para cada bloque
                        const { tags, tagsParsed } = this.processTags(blockContent);
                        const blockTitle = this.extractBlockTitle(blockContent);
                        console.log(blockTitle);
                        const metamodel = this.importMetamodelData(blockTitle);
                        return {
                            id: this.lastId,
                            content: blockContent,
                            tags: tags,
                            tagsParsed: tagsParsed,
                            blockTitle: blockTitle,
                            metamodel: metamodel
                        };
                    });
                    this.updateModelMarkdown();
                    console.log(this.model); // Verificar la carga y transformaci√≥n del contenido
                    window.botpressWebChat.sendEvent({ type: 'hide' })
                },
                extractBlockTitle(blockContent) {
                    const firstBlock = blockContent.split(/\r?\n/)[0]; // Obtiene la primera l√≠nea
                    const firstBlockWithoutMarkdownHeaders = firstBlock.replace(/^#+\s*/, ''); // Elimina los encabezados Markdown
                    const blockTitle = firstBlockWithoutMarkdownHeaders.replace(/#[^\s]+/g, '').trim(); // Elimina las etiquetas y espacios extras
                    return blockTitle; // Retorna blockTitle despu√©s de haber llamado a importMetamodelData
                    console.log(blockTitle);
                },
                importMetamodelData(blockTitle) {
                    // Encuentra la secci√≥n que coincide con blockTitle
                    const section = this.metamodel.sections.find(s => s.name === blockTitle);
                    if (section) {
                        // Suponiendo que quieras actualizar un bloque espec√≠fico en this.model
                        // Necesitar√°s identificar cu√°l bloque actualizar basado en blockTitle o alguna otra l√≥gica
                        const blockIndex = this.model.findIndex(block => block.title === blockTitle);
                        if (blockIndex !== -1) {
                            // Si encontramos un bloque correspondiente, actualizamos ese bloque
                            // Aqu√≠ es donde decides c√≥mo quieres incorporar la secci√≥n al bloque
                            // Por ejemplo, podr√≠as querer a√±adir la secci√≥n encontrada a un array de secciones en el bloque
                            this.$set(this.model[blockIndex], 'section', section);
                        }
                    }
                    // Opcionalmente, devuelve la secci√≥n para uso externo
                    return section;
                },
                processTags(content) {
                    const tags = content.match(/(?:^|\s)(#[^\s]+)/g) || [];
                    const tagsParsed = tags.map(tag => `<span data-tag="${tag.substring(1)}">${tag}</span>`).join('');
                    return {
                        tags: tags.map(tag => tag.substring(1)), // Elimina el s√≠mbolo '#'
                        tagsParsed: tagsParsed
                    };
                },
                updateModelMarkdown() {
                    // Inicializa una variable para almacenar el contenido concatenado
                    let concatenatedContent = '';

                    // Recorre cada elemento del array model y concatena su contenido con saltos de l√≠nea
                    this.model.forEach(item => {
                        concatenatedContent += item.content + '\n';
                    });

                    // Guarda el contenido generado en el campo modelMarkdown del objeto model
                    this.modelMarkdown = concatenatedContent;
                    console.log(concatenatedContent);
                },
                downloadJSON() {
                    axios.get('https://xbokmd.github.io/plastilinn/metamodel.json')
                        .then(response => {
                            if (response.data && response.data.classes && response.data.sections) {
                                this.metamodel = response.data;
                                console.log('Metamodel loaded:', this.metamodel);
                            } else {
                                console.error('Metamodel received does not have the expected structure');
                            }
                        })
                        .catch(error => console.error('Error loading metamodel:', error));
                },
                openModal(block) {
                    console.log("L√≠nea clicada:", block);
                    this.currentBlockId = block.id; // Aseg√∫rate de tener currentBlockId definido en tu data()
                    this.selectedBlockContent = block.content;
                    // Busca el √≠ndice de la l√≠nea bas√°ndose en el ID √∫nico
                    this.selectedBlockIndex = this.model.findIndex(item => item.id === block.id);
                    this.isModalOpen = true;
                    console.log("Modal abierta con contenido:", this.selectedBlockContent, "ID:", block.id);
                    this.$nextTick(() => {
                        // Aseg√∫rate de que el contenedor del editor est√© disponible en el DOM
                        this.initEditor();
                    });
                    console.log("currentBlockId:", this.currentBlockId);
                },
                initEditor() {
                    if (this.editor) {
                        this.editor.destroy(); // Destruye la instancia anterior del editor
                    }
                    this.editor = new toastui.Editor({
                        el: document.querySelector('#editor-container'),
                        initialEditType: 'markdown',
                        previewStyle: 'tab',
                        height: '340px',
                        width: '400px',
                        hideModeSwitch: true,
                        initialValue: this.selectedBlockContent // Asume que `editingContent` es tu contenido actual que quieres editar
                    });
                },
                saveChanges() {
                    const editedContent = this.editor.getMarkdown();
                    if (this.selectedBlockIndex !== null) {
                        const { tags, tagsParsed } = this.processTags(editedContent);
                        const blockTitle = this.extractBlockTitle(editedContent); // Asume que esta funci√≥n devuelve el t√≠tulo del bloque
                        this.model.splice(this.selectedBlockIndex, 1, {
                            ...this.model[this.selectedBlockIndex],
                            content: editedContent,
                            tags: tags,
                            tagsParsed: tagsParsed,
                            blockTitle: blockTitle // Guarda el blockTitle extra√≠do en la propiedad title del objeto
                        });
                    }
                    this.updateModelMarkdown();
                    this.closeModal();
                },
                closeModal() {
                    this.isModalOpen = false;
                },
                updateBlock(index, newContent) {
                    const tags = newContent.match(/#[^\s]+/g) || [];
                    const tagsParsed = tags.map(tag => `<span class="${tag.substring(1)}">${tag.substring(1)}</span>`).join('');
                    const parsedContent = this.parseContent(newContent); // Asume la existencia de esta funci√≥n
                    Vue.set(this.model, index, {
                        ...this.model[index],
                        content: newContent,
                        parsedContent: parsedContent,
                        tags: tags.map(tag => tag.substring(1)),
                        tagsParsed: tagsParsed
                    });
                },
                downloadMarkdown() {
                    // Asume que modelMarkdown y modelName ya est√°n actualizados
                    const markdownContent = this.modelMarkdown; // Obtiene el valor actual de modelMarkdown
                    const modelName = this.modelName; // Obtiene el nombre actual del modelo
                    const timestamp = new Date().toISOString().replace(/[:\-]|\.\d{3}/g, ''); // Genera un timestamp en el formato deseado

                    const fileName = `${modelName} - saved ${timestamp}.md`; // Construye el nombre del archivo

                    // Crea un Blob con el contenido Markdown
                    const blob = new Blob([markdownContent], { type: 'text/markdown' });

                    // Crea un enlace para descargar el archivo
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;

                    // Simula un clic en el enlace para iniciar la descarga y luego limpia
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                generateSuggestionPrompt() {
                    console.log("currentBlockId:", this.currentBlockId);
                    console.log("model:", this.model); // Ahora imprime el arreglo model para verificar
                    let suggestionPrompt = '';
                    let block = this.model.find(b => b.id === this.currentBlockId); // Cambia this.blocks por this.model
                    console.log("block: ", block);
                    let blockTitle = block ? block.blockTitle : 'T√≠tulo no encontrado';
                    console.log("blockTitle: ", blockTitle);
                    let modelMarkdown = this.modelMarkdown;
                    let blockExample = block ? block.metamodel.example : 'Example no encontrado';
                    console.log("blockExample: ", blockExample);
                    suggestionPrompt = `As a business model design expert for startups, you specialize in refining business models through detailed, specific feedback and brainstorming tailored to each startup's unique aspects. Your role is to assist in drafting a document that accurately describes a business model, focusing on clear, structured, and relevant advice. Your approach involves:
                    Listening closely to understand the specifics of the business.
                    Providing concise, targeted guidance without unnecessary repetition or formalities.
                    Offering step-by-step feedback to ensure the document effectively captures the business model.
                    You focus on the client's needs and how to best articulate their business model.
                    GOAL: Write a business model document describing the user's project business model. Here's some information about my Business:
                        ${modelMarkdown}
                    MY QUESTION: Please suggest content for the "${blockTitle}" section of the business model.
                    WRITE your answer in PLASTILINN FORMAT, which consists of the text of the answer without any comments or similar, that closely adheres to the format and style of the plastilinn (taking the {block example} as a reference example of a properly formatted answer). In your response, each list component should begin with '#tag', followed by the name enclosed in double brackets '[[ ]]', and then a description on a new, indented line. This is an example of an answer:
                    ---
                    ${blockExample}
                    ---
                    Copy answer in the text box below:
                    ---
                    \`\`\`
                    ${blockExample}
                    \`\`\`
                    ---
                    - You can copy/paste this answer to a document, write 'copy' to have the answer in a text box or write ‚¨áÔ∏è 'download' to save this answer to your computer`;
                    
                    return suggestionPrompt;
                },
                sendMessageToBot() {
                    console.log(this.currentBlockId);
                    let suggestionPrompt = this.generateSuggestionPrompt();
                    console.log(suggestionPrompt);
                    window.botpressWebChat.mergeConfig({ className: 'plastilinnChatBot', showCloseButton: true})
                    window.botpressWebChat.sendEvent({ type: 'show' })
                    window.botpressWebChat.sendPayload({
                        type: 'text',
                        text: suggestionPrompt
                    });
            },
            },
            mounted() {
                this.downloadJSON(); // Otras inicializaciones pueden ir aqu√≠
                window.botpressWebChat.onEvent(event => {
                    if (event.type === 'message' && event.message_type === 'text') {
                        alert(`Respuesta del bot: ${event.text}`);
                    }
                });
            },
        })
        .component('vue-multiselect', window.VueMultiselect.default) // Registra vue-multiselect como un componente global
        .mount('#vue-app');
    </script>
    <script src='https://cdn.botpress.cloud/webchat/v1/inject.js'></script>
    <script src='https://mediafiles.botpress.cloud/b0e00411-1da8-4c0c-98ec-5b6c44a7fa7b/webchat/config.js' defer></script>
</body>

</html>