<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://xbokmd.github.io/plastilinn/css.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> <!-- Editor's Style -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        .md-line {
            display: flex;
            /* o display: grid; dependiendo de tu estructura */
            gap: 10px;
            /* Ajusta este valor según lo necesites */
        }
    </style>

</head>

<body class="bg-gray-100">
    <div id="top-container">
        <div class="navbar bg-base-100">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl">Plastilinn</a>
            </div>
            <div class="flex items-center space-x-3">
            </div>
            <div style="display: flex; justify-content: center;">
                <div class="flex space-x-3">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex items-center space-x-3" style="justify-content: flex-end;">
                        </div>
                        <div class="flex space-x-3" style="justify-content: center;">
                            <button
                                class="collapse-filter-button btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition"" type="
                                button">
                                🔍 Filter
                            </button>
                        </div>
                        <div class="flex items-center justify-end space-x-3" style="justify-content: flex-start;">
                            <button id="downloadBtn"
                                class="btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition">⬇️
                                Download</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-none">
                <ul class="menu menu-horizontal px-1">
                    <li><a>App</a></li>
                    <li><a>Docs</a></li>
                    <li><a>About</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="model-title" class="text-center mt-6">
        <!-- El nombre del modelo se mostrará aquí -->
    </div>
    <div class="mt-4 w-4/5 mx-auto">
        <div class="collapse-filter-content hidden ">
            <select class="select select-bordered w-full" id="tagsFilter" multiple>
                <!-- Opciones del filtro serán generadas dinámicamente -->
            </select>
        </div>
    </div>
    <button id="downloadBtn" @click="downloadMarkdown" class="btn ...">⬇️ Download</button>
    <div id="vue-app">
        <!-- El input de archivo Markdown se moverá aquí, gestionado por Vue -->
        <input type="file" @change="loadAndParseMarkdown" accept=".md">
        <!-- El resto de tu aplicación Vue -->
        <div id="vue-app">
            <div class="modelContainer">
                <div v-for="line in parsedModel" :key="line.id" class="md-line">
                    <div v-html="line.parsedContent"></div>
                    <button @click="openModal(line)" class="btn btn-primary ml-4">Edit</button>
                </div>
            </div>
            <!-- Modal para editar el contenido de la línea seleccionada -->
            <div v-if="isModalOpen" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mt-2">
                            <input v-model="selectedLineContent" type="text"
                                class="input input-bordered w-full max-w-xs" />
                        </div>
                        <button class="btn btn-primary mt-4" @click="saveChanges">Guardar Cambios</button>
                        <button class="btn btn-secondary mt-4" @click="closeModal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="markdownContainer" class="mt-4 ml-2 mr-2 text-gray-900 min-h-screen">

    </div>

    <script>
        Vue.createApp({
            data() {
                return {
                    metamodel: [],
                    model: [], // Se utilizará para almacenar el modelo de datos creado a partir del Markdown
                    modelName: '',
                    isModalOpen: false,
                    selectedLineContent: '',
                    selectedLineIndex: null,
                };
            },
            computed: {
                parsedModel() {
                return this.model.map(line => {
                    return { ...line, parsedContent: marked.parse(line.content) };
                });
                }
            },
            methods: {
                loadAndParseMarkdown(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        this.parseMarkdown(content);
                    };
                    reader.readAsText(file);
                },
                parseMarkdown(content) {
                    // Se utiliza una expresión regular para dividir el contenido en líneas
                    const lines = content.split(/\r?\n/);
                    this.model = lines.map(line => {
                        // Aquí puedes ajustar cómo quieres transformar cada línea en un objeto de tu modelo
                        return { content: line };
                    });
                    console.log(this.model); // Verificar la carga y transformación del contenido
                },
                regenerateLine(index) {
                    // Asume que tienes una función que procesa el contenido, por ejemplo, `processContent`
                    const processedContent = this.processContent(this.model[index].content);
                    // Actualiza el elemento correspondiente en parsedModel
                    this.$set(this.parsedModel, index, { ...this.parsedModel[index], parsedContent: processedContent });
                },

                processContent(content) {
                    // Aquí va tu lógica para procesar el contenido
                    return processedContent;
                },
                downloadJSON() {
                    axios.get('https://xbokmd.github.io/plastilinn/metamodel.json')
                        .then(response => {
                            if (response.data && response.data.classes && response.data.sections) {
                                this.metamodel = response.data;
                                console.log('Metamodel loaded:', this.metamodel);
                            } else {
                                console.error('Metamodel received does not have the expected structure');
                            }
                        })
                        .catch(error => console.error('Error loading metamodel:', error));
                },
                updateModelNameDisplay() {
                    this.modelName = 'Nuevo Nombre'; // Lógica para actualizar el nombre del modelo
                },
                openModal(line) {
                    console.log("Línea clicada:", line);
                    this.selectedLineContent = line.content;
                    this.selectedLineIndex = this.model.indexOf(line);
                    this.isModalOpen = true;
                    console.log("Modal abierta con contenido:", this.selectedLineContent);
                },
                saveChanges() {
                    if (this.selectedLineIndex !== null) {
                        const updatedLine = { ...this.model[this.selectedLineIndex], content: this.selectedLineContent };
                        console.log(`Cambios guardados para la línea ${this.selectedLineIndex}: ${this.selectedLineContent}`);
                        this.model.splice(this.selectedLineIndex, 1, updatedLine);
                        console.log(`Cambios guardados para la línea ${this.selectedLineIndex}: ${this.selectedLineContent}`);
                    }
                    this.closeModal();
                },
                closeModal() {
                    this.isModalOpen = false;
                },
                downloadMarkdown() {
                    console.log(`boton pulsado`);
                    const markdownContent = this.model.map(item => item.content).join('\n\n');
                    const blob = new Blob([markdownContent], { type: 'text/markdown' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'model-content.md';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
            },
            mounted() {
                this.downloadJSON(); // Otras inicializaciones pueden ir aquí
            },
        }).mount('#vue-app');
    </script>s
</body>

</html>