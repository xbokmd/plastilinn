<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://xbokmd.github.io/plastilinn/css.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> <!-- Editor's Style -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
    .md-block {
        display: flex;
        /* o display: grid; dependiendo de tu estructura */
        gap: 10px;
        /* Ajusta este valor seg칰n lo necesites */
    }
    .md-block-container-middle > div {
    /* Tus estilos aqu칤 */
    border-bottom: 1px solid #F5F5F5;
    padding: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .toastui-editor-defaultUI div[contenteditable="true"] {
        text-align: left;
    }
        </style>

</head>

<body class="bg-gray-100">
    <div id="vue-app">
    <div id="top-container">
        <div class="navbar bg-base-100">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl">Plastilinn</a>
            </div>
            <div class="flex items-center space-x-3">
            </div>
            <div style="display: flex; justify-content: center;">
                <div class="flex space-x-3">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex items-center space-x-3" style="justify-content: flex-end;">
                        </div>
                        <div class="flex space-x-3" style="justify-content: center;">
                            <button
                                class="collapse-filter-button btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition" type="
                                button">
                                游댌 Filter
                            </button>
                        </div>
                        <div class="flex items-center justify-end space-x-3" style="justify-content: flex-start;">
                            <button id="downloadBtn"
                                class="btn border-blue-500 text-blue-500 bg-white hover:bg-blue-500 hover:text-white px-4 py-2 rounded-md transition">拘勇
                                Download</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-none">
                <ul class="menu menu-horizontal px-1">
                    <li><a>App</a></li>
                    <li><a>Docs</a></li>
                    <li><a>About</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="model-title" class="text-center mt-6">
        <!-- El nombre del modelo se mostrar치 aqu칤 -->
    </div>
    <div class="mt-4 w-4/5 mx-auto">
        <div class="collapse-filter-content hidden ">
            <select class="select select-bordered w-full" id="tagsFilter" multiple>
                <!-- Opciones del filtro ser치n generadas din치micamente -->
            </select>
        </div>
    </div>
    <button id="downloadBtn" @click="downloadMarkdown" class="btn ...">拘勇 Download</button>
        <!-- El input de archivo Markdown se mover치 aqu칤, gestionado por Vue -->
        <input type="file" @change="loadAndParseMarkdown" accept=".md" class="file-input file-input-bordered file-input-primary w-full max-w-xs m-4">
        <!-- El resto de tu aplicaci칩n Vue -->
            <h1 v-if="modelName">{{ modelName }}</h1>
            <div class="modelContainer mt-4 ml-2 mr-2 text-gray-900 min-h-screen">
                <div class="flex flex-row w-full">
                    <div class="md-block-wrapper w-full">
                        <div v-for="block in parsedModel" :key="block.id" class="md-block flex">
                            <div class="md-block-container-left w-1/4">
                            <div class="block-metamodel" v-if="block.metamodel">
                                <a :href="block.metamodel.info" target="_blank">{{ block.metamodel.name }}</a>
                              </div>
                            </div>
                            <button class="btn ai-magic-button py-1">游뱄 AI magic</button>
                            <div class="md-block-container-middle md-block-content shadow-xl hover:shadow-2xl transition-shadow p-2 ml-2 mr-2 custom-flex-2 w-1/2">
                                <div v-html="block.parsedContent"></div>
                            </div><button @click="openModal(block)" class="btn inblock-block rounded px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-primary transition duration-150 ease-in-out hover:bg-neutral-100 hover:text-primary-600 focus:text-primary-600 focus:outline-none focus:ring-0 active:text-primary-700 m-0 p-2">九勇</button>
                            <div class="md-block-container-right tags-container text-gray-500 text-sm text-center p-2 w-1/4"
                                v-html="block.tagsParsed"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal para editar el contenido de la l칤nea seleccionada -->

            <div v-if="isModalOpen" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-4/5 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mt-2">
                            <div id="editor-container"></div>

                        </div>
                        <button class="btn m-2" @click="saveChanges">Save changes</button>
                        <button class="btn m-2" @click="closeModal">Close window</button>
                    </div>
                </div>
            </div>
    </div>

    <script>
        Vue.createApp({
            data() {
                return {
                    metamodel: [],
                    model: [], // Se utilizar치 para almacenar el modelo de datos creado a partir del Markdown
                    lastId: 0, // Inicializa un contador para los IDs
                    modelName: '',
                    modelMarkdown: '', // Campo para almacenar el contenido Markdown concatenado
                    isModalOpen: false,
                    selectedBlockContent: '',
                    selectedBlockIndex: null,
                    blocks: [], // Puedes inicializarlo como un array vac칤o o con valores iniciales
                };
            },
            computed: {
                parsedModel() {
                    return this.model.map(block => {
                        return { ...block, parsedContent: marked.parse(block.content) };
                    });
                }
            },
            methods: {
                loadAndParseMarkdown(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return;
                    }
                    const modelName = this.getModelNameFromFileName(file.name);
                    this.modelName = modelName; // Actualiza modelName con el resultado de la funci칩n
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        this.parseMarkdown(content);
                    };
                    reader.readAsText(file);
                },
                getModelNameFromFileName(fileName) {
                    let name = fileName.replace(/\.md$/, ''); // Elimina la extensi칩n ".md"
                    name = name.replace(/ - saved.*$/, ''); // Elimina " - saved" y todo lo que sigue
                    return name;
                },
                parseMarkdown(content) {
                    const blocks = []; // Almacenar치 los bloques identificados
                    let currentBlock = []; // Almacena las l칤neas del bloque actual
                    const lines = content.split(/\r?\n/); // Divide el contenido en l칤neas

                    lines.forEach(line => {
                        // Verifica si la l칤nea actual marca el inicio de un nuevo bloque
                        if (/^\s*-*\s*#/.test(line)) {
                            if (currentBlock.length > 0) {
                                blocks.push(currentBlock.join('\n')); // Agrega el bloque actual a los bloques
                                currentBlock = []; // Reinicia el bloque actual
                            }
                        }
                        currentBlock.push(line); // A침ade la l칤nea al bloque actual
                    });
                    if (currentBlock.length > 0) {
                        blocks.push(currentBlock.join('\n')); // Aseg칰rate de a침adir el 칰ltimo bloque
                    }

                    // Actualiza this.model para que contenga bloques en lugar de l칤neas individuales
                    this.model = blocks.map((blockContent, index) => {
                        this.lastId += 1; // Incrementa el ID para cada bloque
                        const { tags, tagsParsed } = this.processTags(blockContent);
                        const blockTitle = this.extractBlockTitle(blockContent);
                        console.log(blockTitle);
                        const metamodel = this.importMetamodelData(blockTitle);
                        return {
                            id: this.lastId,
                            content: blockContent,
                            tags: tags,
                            tagsParsed: tagsParsed,
                            blockTitle: blockTitle,
                            metamodel: metamodel
                        };
                    });
                    this.updateModelMarkdown();
                    console.log(this.model); // Verificar la carga y transformaci칩n del contenido
                },
                extractBlockTitle(blockContent) {
                    const firstBlock = blockContent.split(/\r?\n/)[0]; // Obtiene la primera l칤nea
                    const firstBlockWithoutMarkdownHeaders = firstBlock.replace(/^#+\s*/, ''); // Elimina los encabezados Markdown
                    const blockTitle = firstBlockWithoutMarkdownHeaders.replace(/#[^\s]+/g, '').trim(); // Elimina las etiquetas y espacios extras
                    return blockTitle; // Retorna blockTitle despu칠s de haber llamado a importMetamodelData
                    console.log(blockTitle);
                },
                importMetamodelData(blockTitle) {
                    // Encuentra la secci칩n que coincide con blockTitle
                    const section = this.metamodel.sections.find(s => s.name === blockTitle);
                    if (section) {
                        // Suponiendo que quieras actualizar un bloque espec칤fico en this.model
                        // Necesitar치s identificar cu치l bloque actualizar basado en blockTitle o alguna otra l칩gica
                        const blockIndex = this.model.findIndex(block => block.title === blockTitle);
                        if (blockIndex !== -1) {
                            // Si encontramos un bloque correspondiente, actualizamos ese bloque
                            // Aqu칤 es donde decides c칩mo quieres incorporar la secci칩n al bloque
                            // Por ejemplo, podr칤as querer a침adir la secci칩n encontrada a un array de secciones en el bloque
                            this.$set(this.model[blockIndex], 'section', section);
                        }
                    }
                    // Opcionalmente, devuelve la secci칩n para uso externo
                    return section;
                },
                processTags(content) {
                    const tags = content.match(/#[^\s]+/g) || [];
                    const tagsParsed = tags.map(tag => `<span data-tag="${tag.substring(1)}">${tag}</span>`).join('');
                    return {
                        tags: tags.map(tag => tag.substring(1)), // Elimina el s칤mbolo '#'
                        tagsParsed: tagsParsed
                    };
                },
                updateModelMarkdown() {
                    // Inicializa una variable para almacenar el contenido concatenado
                    let concatenatedContent = '';

                    // Recorre cada elemento del array model y concatena su contenido con saltos de l칤nea
                    this.model.forEach(item => {
                    concatenatedContent += item.content + '\n';
                    });

                    // Guarda el contenido generado en el campo modelMarkdown del objeto model
                    this.modelMarkdown = concatenatedContent;
                    console.log(concatenatedContent);
                },
                downloadJSON() {
                    axios.get('https://xbokmd.github.io/plastilinn/metamodel.json')
                        .then(response => {
                            if (response.data && response.data.classes && response.data.sections) {
                                this.metamodel = response.data;
                                console.log('Metamodel loaded:', this.metamodel);
                            } else {
                                console.error('Metamodel received does not have the expected structure');
                            }
                        })
                        .catch(error => console.error('Error loading metamodel:', error));
                },
                openModal(block) {
                    console.log("L칤nea clicada:", block);
                    this.selectedBlockContent = block.content;
                    // Busca el 칤ndice de la l칤nea bas치ndose en el ID 칰nico
                    this.selectedBlockIndex = this.model.findIndex(item => item.id === block.id);
                    this.isModalOpen = true;
                    console.log("Modal abierta con contenido:", this.selectedBlockContent, "ID:", block.id);
                    this.$nextTick(() => {
                        // Aseg칰rate de que el contenedor del editor est칠 disponible en el DOM
                        this.initEditor();
                    });
                },
                initEditor() {
                    if (this.editor) {
                        this.editor.destroy(); // Destruye la instancia anterior del editor
                    }
                    this.editor = new toastui.Editor({
                            el: document.querySelector('#editor-container'),
                            initialEditType: 'markdown',
                            previewStyle: 'tab',
                            height: '500px',
                            hideModeSwitch:true,
                            initialValue: this.selectedBlockContent // Asume que `editingContent` es tu contenido actual que quieres editar
                    });
                },
                saveChanges() {
                    const editedContent = this.editor.getMarkdown();
                    if (this.selectedBlockIndex !== null) {
                        const { tags, tagsParsed } = this.processTags(editedContent);
                        const blockTitle = this.extractBlockTitle(editedContent); // Asume que esta funci칩n devuelve el t칤tulo del bloque
                        this.model.splice(this.selectedBlockIndex, 1, {
                            ...this.model[this.selectedBlockIndex],
                            content: editedContent,
                            tags: tags,
                            tagsParsed: tagsParsed,
                            blockTitle: blockTitle // Guarda el blockTitle extra칤do en la propiedad title del objeto
                        });
                    }
                    this.updateModelMarkdown();
                    this.closeModal();
                },
                closeModal() {
                    this.isModalOpen = false;
                },
                updateBlock(index, newContent) {
                    const tags = newContent.match(/#[^\s]+/g) || [];
                    const tagsParsed = tags.map(tag => `<span class="${tag.substring(1)}">${tag.substring(1)}</span>`).join('');
                    const parsedContent = this.parseContent(newContent); // Asume la existencia de esta funci칩n
                    Vue.set(this.model, index, {
                        ...this.model[index],
                        content: newContent,
                        parsedContent: parsedContent,
                        tags: tags.map(tag => tag.substring(1)),
                        tagsParsed: tagsParsed
                    });
                },
                downloadMarkdown() {
                    // Asume que modelMarkdown y modelName ya est치n actualizados
                    const markdownContent = this.modelMarkdown; // Obtiene el valor actual de modelMarkdown
                    const modelName = this.modelName; // Obtiene el nombre actual del modelo
                    const timestamp = new Date().toISOString().replace(/[:\-]|\.\d{3}/g, ''); // Genera un timestamp en el formato deseado
                    
                    const fileName = `${modelName} - saved ${timestamp}.md`; // Construye el nombre del archivo

                    // Crea un Blob con el contenido Markdown
                    const blob = new Blob([markdownContent], { type: 'text/markdown' });

                    // Crea un enlace para descargar el archivo
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;

                    // Simula un clic en el enlace para iniciar la descarga y luego limpia
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    },
            },
            mounted() {
                this.downloadJSON(); // Otras inicializaciones pueden ir aqu칤
            },
        }).mount('#vue-app');
    </script>s
</body>

</html>